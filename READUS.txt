smart_home_backend/
â”‚
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                â† Khá»Ÿi cháº¡y FastAPI (HTTP API)
â”‚   â”œâ”€â”€ mqtt_app.py            â† Cháº¡y MQTT client/subscriberâ”‚
â”‚   â”œâ”€â”€ database/
â”‚   â”‚   â”œâ”€â”€ connection.py      â† MySQL connection (SQLAlchemy)
â”‚   â”‚   â””â”€â”€ base.py
â”‚
â”‚   â”œâ”€â”€ models/                â† ORM mapping DB table
â”‚   â”‚   â”œâ”€â”€ device.py
â”‚   â”‚   â”œâ”€â”€ device_history.py
â”‚   â”‚   â””â”€â”€ voice_history.py
â”‚
â”‚   â”œâ”€â”€ schemas/               â† Pydantic request/response schema
â”‚
â”‚   â”œâ”€â”€ repositories/          â† CRUD vá»›i DB
â”‚
â”‚   â”œâ”€â”€ services/              â† Business logic
â”‚   â”‚   â”œâ”€â”€ device_service.py
â”‚   â”‚   â””â”€â”€ voice_service.py
â”‚
â”‚   â”œâ”€â”€ routers/               â† HTTP API Routes
â”‚   â”‚   â”œâ”€â”€ device_routes.py
â”‚   â”‚   â”œâ”€â”€ history_routes.py
â”‚   â”‚   â””â”€â”€ voice_routes.py
â”‚
â”‚   â”œâ”€â”€ mqtt/     
â”‚   â”‚   â”œâ”€â”€ mqtt_client.py     â† MQTT publish/subscribe
|   |   â”œâ”€â”€ mqtt_handler.py      ğŸ‘‰ Xá»­ lÃ½ tá»«ng topic
â”‚   â”‚   â””â”€â”€ mqtt_service.py    â† Xá»­ lÃ½ payload tá»« MQTT
â”‚   â”œâ”€â”€ .env                   â† Config DB , MQTT
â””â”€â”€ run_http.py                â† Cháº¡y API (uvicorn)
â””â”€â”€ run_mqtt.py                â† Cháº¡y MQTT worker (background)

| Luá»“ng               | LÃ m gÃ¬                                                         | Code náº±m Ä‘Ã¢u?                                |
| ------------------- | -------------------------------------------------------------- | -------------------------------------------- |
| HTTP                | Giao tiáº¿p vá»›i Web, Mobile, CRUD device, history                | `routers/`, `services/`, `repositories/`     |
| MQTT Subscribe      | Nháº­n dá»¯ liá»‡u cáº£m biáº¿n / giá»ng nÃ³i tá»« ESP32/Raspberry Pi        | `mqtt_client.py`, `mqtt_service.py`          |
| MQTT Publish        | Gá»­i lá»‡nh Ä‘iá»u khiá»ƒn thiáº¿t bá»‹                                   | `mqtt_client.py`, gá»i tá»« `device_service.py` |
| NLP xá»­ lÃ½ giá»ng nÃ³i | Sau khi nháº­n `raw text` tá»« MQTT â†’ xá»­ lÃ½ backend â†’ nháº­n ra lá»‡nh | `voice_processor.py`, `voice_service.py`     |

Luá»“ng hoáº¡t Ä‘á»™ng thá»±c táº¿ (MQTT Ä‘iá»u khiá»ƒn)
ESP32 â†’ MQTT Broker â†’ backend â†’ xá»­ lÃ½ payload â†’ update DB â†’ publish ngÆ°á»£c â†’ ESP32 nháº­n lá»‡nh
Luá»“ng xá»­ lÃ½ Voice (INMP441)
ESP32 (Mic) â†’ MQTT (raw text) â†’ backend xá»­ lÃ½ NLP â†’ xÃ¡c Ä‘á»‹nh lá»‡nh â†’ update VoiceHistory + DeviceHistory â†’ publish MQTT â†’ ESP32 báº­t thiáº¿t bá»‹
